package com.ssafy.a302.repository;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;

import com.ssafy.a302.domain.Feed;
import com.ssafy.a302.domain.Purchase;
import com.ssafy.a302.domain.Snack;
import com.ssafy.a302.domain.SubscribtionHistory;
import com.ssafy.a302.domain.Toy;
import com.ssafy.a302.domain.Users;

import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

public interface SubscriptionsHistoryRepository extends JpaRepository<SubscribtionHistory, Integer>{
	@Query("select s from SubscribtionHistory s where s.users.usersSno = :userId and s.startDate <= CURRENT_DATE and s.endDate > CURRENT_DATE")
	List<SubscribtionHistory> findSubNowByUserId(@Param("userId") String userId);

	@Query("select s from SubscribtionHistory s where s.users.usersSno = :userId")
	List<SubscribtionHistory> findSubAllByUserId(@Param("userId")String userId);

	@Query("select p from Purchase p where p.subscribtionHistory.subscribtionHistoryNo = :subId")
	List<Purchase> findPurchaseBySubId(@Param("subId")String subId);

	@Query("select f from Feed f join f.feedEffects join f.feedMaterials join f.feedTargets join f.grade join f.particle where f.feedSno = :feedId")
	Feed findFeedInfo(@Param("feedId")String feedId);

	@Query("select t from Toy t where t.toySno = :toyId")
	Toy findToyInfo(@Param("toyId")String toyId);

	@Query("select s from Snack s join s.snackEffects join s.snackMaterials join s.snackTargets  where s.snackSno = :snackId")
	Snack findSnackInfo(@Param("snackId")String snackId);

	@Modifying
	@Query("update SubscribtionHistory s set s.autoPaymentFlag = 0 where s.subscribtionHistoryNo = :historyId")
	void updateSubInfoAsCanceled(@Param("historyId")int historyId);

	}
